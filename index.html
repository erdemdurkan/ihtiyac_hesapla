<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8">
  <title>Stok Hesaplama</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background:
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%),
        linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Ccircle cx='30' cy='30' r='1'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      animation: float 20s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(30px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 32px;
      padding: 60px 50px;
      box-shadow:
        0 32px 64px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
      max-width: 520px;
      width: 100%;
      text-align: center;
      position: relative;
      z-index: 1;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
      border-radius: 32px;
      pointer-events: none;
    }

    .container:hover {
      transform: translateY(-8px);
      box-shadow:
        0 40px 80px rgba(0, 0, 0, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 32px;
      box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
      position: relative;
      overflow: hidden;
    }

    .badge::before {
      content: 'âœ¨';
      margin-right: 8px;
      font-size: 16px;
    }

    .badge::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        left: -100%;
      }

      100% {
        left: 100%;
      }
    }

    h2 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 70%, #f093fb 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 16px;
      line-height: 1.2;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: #64748b;
      font-size: 16px;
      margin-bottom: 48px;
      line-height: 1.6;
      font-weight: 400;
    }

    .input-group {
      margin-bottom: 32px;
      text-align: left;
    }

    .input-label {
      display: flex;
      align-items: center;
      color: #374151;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      position: relative;
    }

    .input-label::before {
      content: 'ðŸ“‹';
      margin-right: 12px;
      font-size: 20px;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .file-input-wrapper {
      position: relative;
      border: 2px dashed #e2e8f0;
      border-radius: 20px;
      padding: 32px 24px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      overflow: hidden;
    }

    .file-input-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .file-input-wrapper:hover {
      border-color: #667eea;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      transform: translateY(-4px);
      box-shadow: 0 16px 32px rgba(102, 126, 234, 0.1);
    }

    .file-input-wrapper:hover::before {
      opacity: 1;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      font-size: 15px;
      font-weight: 500;
      position: relative;
      z-index: 1;
    }

    .file-placeholder::before {
      content: 'ðŸ“¤';
      margin-right: 12px;
      font-size: 24px;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.1));
    }

    .convert-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 20px 32px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 16px 32px rgba(102, 126, 234, 0.3);
    }

    .convert-btn::before {
      content: 'ðŸš€';
      margin-right: 12px;
      font-size: 18px;
    }

    .convert-btn::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .convert-btn:hover {
      transform: translateY(-6px);
      box-shadow: 0 24px 48px rgba(102, 126, 234, 0.4);
      background: linear-gradient(135deg, #764ba2 0%, #f093fb 50%, #667eea 100%);
    }

    .convert-btn:hover::after {
      left: 100%;
    }

    .convert-btn:active {
      transform: translateY(-2px);
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 32px;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(102, 126, 234, 0.2);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    .loading-text {
      color: #6b7280;
      font-size: 16px;
      font-weight: 500;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .success-message {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 20px 32px;
      border-radius: 16px;
      margin-top: 32px;
      text-align: center;
      font-weight: 600;
      display: none;
      box-shadow: 0 16px 32px rgba(16, 185, 129, 0.3);
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 40px 32px;
        margin: 16px;
        border-radius: 24px;
      }

      h2 {
        font-size: 28px;
      }

      .file-input-wrapper {
        padding: 24px 20px;
      }

      .convert-btn {
        padding: 18px 24px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="badge">Excel Ä°ÅŸleyici</div>
    <h2>Ä°htiyaÃ§ Hesaplama AracÄ±</h2>
    <p class="subtitle">Excel dosyalarÄ±nÄ±zÄ± yÃ¼kleyip otomatik hesaplama yapÄ±n</p>

    <div class="input-group">
      <div class="input-label">PLAN DosyalarÄ±nÄ± YÃ¼kle (.xlsx) En fazla 3</div>
      <div class="file-input-wrapper">
        <input type="file" id="planFiles" accept=".xlsx,.xls" multiple />
        <div class="file-placeholder">Dosya seÃ§mek iÃ§in tÄ±klayÄ±n (.xlsx, .xls)</div>
      </div>
    </div>

    <div class="input-group">
      <div class="input-label">EX_STOK DosyasÄ±nÄ± YÃ¼kle</div>
      <div class="file-input-wrapper">
        <input type="file" id="stokFile" accept=".xlsx,.xls" />
        <div class="file-placeholder">Dosya seÃ§mek iÃ§in tÄ±klayÄ±n (.xlsx, .xls)</div>
      </div>
    </div>

    <button class="convert-btn" onclick="convertAndDownload()">Ä°ÅŸlemi BaÅŸlat</button>

    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">Dosyalar iÅŸleniyor...</div>
    </div>

    <div class="success-message" id="successMessage">
      âœ“ Dosya baÅŸarÄ±yla oluÅŸturuldu ve indirildi!
    </div>
  </div>

  <script>
    function convertAndDownload() {
      const planInputs = document.getElementById("planFiles").files;
      const stokInput = document.getElementById("stokFile").files[0];
      const loading = document.getElementById("loading");
      const successMessage = document.getElementById("successMessage");

      // Reset messages
      loading.style.display = "none";
      successMessage.style.display = "none";

      if (planInputs.length === 0 || !stokInput) {
        alert("LÃ¼tfen tÃ¼m dosyalarÄ± seÃ§iniz.");
        return;
      }

      if (planInputs.length > 3) {
        alert("En fazla 3 plan dosyasÄ± seÃ§ebilirsiniz.");
        return;
      }

      // Show loading
      loading.style.display = "block";

      const planDataList = [];
      let filesRead = 0;

      for (let i = 0; i < planInputs.length; i++) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet);
          planDataList.push(...json);

          filesRead++;
          if (filesRead === planInputs.length) {
            readStokAndProcess(planDataList, stokInput);
          }
        };
        reader.readAsArrayBuffer(planInputs[i]);
      }
    }

    function readStokAndProcess(planJson, stokInput) {
      const readerStok = new FileReader();
      readerStok.onload = (eStok) => {
        const stokData = new Uint8Array(eStok.target.result);
        const stokWorkbook = XLSX.read(stokData, { type: "array" });
        const stokSheet = stokWorkbook.Sheets[stokWorkbook.SheetNames[0]];
        const stokJson = XLSX.utils.sheet_to_json(stokSheet);

        const stokFiltered = stokJson.filter(row =>
          row["SORGULAMA_NOKTASI"] === "AYAR" || row["SORGULAMA_NOKTASI"] === "MONTAJ"
        );

        // Stok haritasÄ±: SASI_KODU_3|PCB_KODU -> adet
        const stokMap = {};
        stokFiltered.forEach(row => {
          const kod = (row["SASI_KODU_3"] || "").toString();
          const grup = (row["PCB_KODU"] || "").toString();
          const adet = Number(row["ADET"]) || 0;
          const key = kod + "|" + grup;
          stokMap[key] = (stokMap[key] || 0) + adet;
        });

        // Plan haritasÄ±: ilk 3 karakter (Ã¶r: 5BX) -> toplam adet
        const planMap = {};
        planJson.forEach(row => {
          const eBaslik = Object.keys(row)[4];
          if (eBaslik !== "SASI 110" && eBaslik !== "LIPS 140") return;
          const kod = (row[eBaslik] || "").toString().substring(0, 3);
          const adet = Number(row["PLAN"]) || 0;
          planMap[kod] = (planMap[kod] || 0) + adet;
        });

        const results = [];
        const stokKodlar = new Set();

        // Stokta olanlar iÃ§in
        for (const key in stokMap) {
          const [kod, grup] = key.split("|");
          stokKodlar.add(kod);
          const stokAdet = stokMap[key];
          const planAdet = planMap[kod] || 0;
          const ihtiyac = Math.max(planAdet - stokAdet, 0);
          if (ihtiyac > 0) {
            results.push({ SASI_KODU: kod, PCB_KODU: grup, IHTIYAC: ihtiyac });
          }
        }

        // Plan'da olup stokta olmayanlar iÃ§in
        for (const kod in planMap) {
          if (!stokKodlar.has(kod)) {
            results.push({ SASI_KODU: kod, PCB_KODU: "", IHTIYAC: planMap[kod] });
          }
        }

        const ws = XLSX.utils.json_to_sheet(results);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sayfa1");

        const now = new Date();
        const pad = n => n.toString().padStart(2, '0');
        const tarihSaat = `${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}`;
        const dosyaAdi = `Stok_${tarihSaat}.xlsx`;

        // Hide loading and show success
        document.getElementById("loading").style.display = "none";
        document.getElementById("successMessage").style.display = "block";

        XLSX.writeFile(wb, dosyaAdi);
      };
      readerStok.readAsArrayBuffer(stokInput);
    }

    // --- Dosya kutusunun tamamÄ± tÄ±klanabilir ve dosya isimleri gÃ¶rÃ¼nsÃ¼n ---
    document.querySelectorAll('.file-input-wrapper').forEach(wrapper => {
      wrapper.addEventListener('click', function (e) {
        if (e.target.tagName !== 'INPUT') {
          const input = wrapper.querySelector('input[type="file"]');
          input && input.click();
        }
      });
    });

    function updateFileNames(input, placeholder) {
      if (input.files.length > 0) {
        const names = Array.from(input.files).map(f => f.name).join(', ');
        placeholder.textContent = names;
      } else {
        placeholder.textContent = 'Dosya seÃ§mek iÃ§in tÄ±klayÄ±n (.xlsx, .xls)';
      }
    }

    document.querySelectorAll('.file-input-wrapper input[type="file"]').forEach(input => {
      const placeholder = input.parentElement.querySelector('.file-placeholder');
      input.addEventListener('change', function () {
        updateFileNames(input, placeholder);
      });
    });
  </script>
</body>

</html>
